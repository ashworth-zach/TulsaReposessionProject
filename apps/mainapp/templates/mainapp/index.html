<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'mainapp/css/style.css' %}" media="all">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <title>edit wish</title>
</head>

<body onload="init();">
    <h1 class="jumbotron text-center">check reposessions</h1>
    <h1>Take a snapshot to check your tag</h1>
    Click on the Start WebCam button.
    <p>
        <button onclick="startWebcam();">Start WebCam</button>
        <button onclick="stopWebcam();">Stop WebCam</button>
        <button onclick="snapshot();">Take Snapshot</button>
    </p>
    <video onclick="snapshot(this);" width=400 height=400 id="video" controls autoplay></video>
    <p>Screenshots :</p>
    <form action="/processimage" method="post" id="myForm">{% csrf_token %}
        <input type="button" value="Upload" onclick="upload()"></form>
    <canvas id="myCanvas" width="400" height="350"></canvas>

    <script>
        //--------------------
        // GET USER MEDIA CODE
        //--------------------
        navigator.getUserMedia = (navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia);

        var video;
        var webcamStream;
        var x;
        function startWebcam() {
            if (navigator.getUserMedia) {
                navigator.getUserMedia(

                    // constraints
                    {
                        video: true,
                        audio: false
                    },

                    // successCallback
                    function (localMediaStream) {
                        video = document.querySelector('video');
                        video.src = window.URL.createObjectURL(localMediaStream);
                        webcamStream = localMediaStream;
                    },

                    // errorCallback
                    function (err) {
                        console.log("The following error occured: " + err);
                    }
                );
            } else {
                console.log("getUserMedia not supported");
            }
        }

        function stopWebcam() {
            webcamStream.stop();
        }
        //---------------------
        // TAKE A SNAPSHOT CODE
        //---------------------
        var canvas, ctx;

        function init() {
            // Get the canvas and obtain a context for
            // drawing in it
            canvas = document.getElementById("myCanvas");
            ctx = canvas.getContext('2d');
        }

        function snapshot() {
            // Draws current image from the video element into the canvas
            x = ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
        function upload() {
            console.log("Uploading...")
            var image = x;//document.getElementById('myCanvas').src;
            var form = document.getElementById('myForm');
            var formData = new FormData(form);
            formData.append("file", image);
            console.log(formData);
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.open("POST", "/processimage");
            xmlhttp.send(formData);
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                alert(xmlhttp.responseText);
            }

        }

    </script>



    <form action='/find' method='post' class='ajax_form'>
        Find specific tag
        {% csrf_token %}
        <input type='text' name='tagstartswith' id='ajax_tag' />
    </form>


    <p>last updated {{data.0.ListUpdateDate}}</p>

    <div class="container" id='table'>
        <table>
            <th>Tag Number</th>
            <th>State</th>
            <th>Year</th>
            <th>Make</th>
            <th>Model</th>
            <th>Color</th>
            <th>Notice Date</th>
            {%for notice in data%}

            <tr>
                <td>{{notice.TagNumber}}</td>
                <td>{{notice.State}}</td>
                <td>{{notice.Year}}</td>
                <td>{{notice.Make}}</td>
                <td>{{notice.Model}}</td>
                <td>{{notice.Color}}</td>
                <td>{{notice.NoticeDate}}</td>
            </tr>
            {%endfor%}
        </table>
    </div>




    <script>
        $('.ajax_form').submit(function (e) {
            e.preventDefault()
        })
        $('#ajax_tag').keyup(function () {
            console.log('Sending Ajax request to /find')
            console.log('Submitting the following data', $(this).parent().serialize())
            $.ajax({
                url: '/find', /* Where should this go? */
                method: 'post', /* Which HTTP verb? */
                data: $(this).parent().serialize(), /* Any data to send along? */
                success: function (serverResponse) { /* What code should we run when the server responds? */
                    $('#table').html(serverResponse)
                }
            })
        });
    </script>


</body>

</html>